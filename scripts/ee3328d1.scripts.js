"use strict";angular.module("blacksunApp",["ngRoute","ngAnimate","ui.bootstrap","wu.masonry","firebase"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainPageCtrl",resolve:{getInstgram:function(a,b){var c=b.defer();return a.getInstaStream().then(function(a){return c.resolve(a)}),c.promise}}}).when("/shop",{templateUrl:"views/shop.html"}).when("/mainPageAdmin",{templateUrl:"views/mainPageAdmin.html",controller:"MainpageadminCtrl"}).otherwise({redirectTo:"/"})}]).run(["$location","$rootScope","FBretrieves","FBURL","$window",function(a,b,c,d,e){var f=angular.element(e.document.body),g=["/mainPageAdmin"],h=new Firebase(d);c.retrieveEmails().then(function(a){b.emailsObj=a}),localStorage.adminLoged&&void 0!==localStorage.adminLoged||(localStorage.adminLoged=""),b.$on("$routeChangeStart",function(c,d){f.css({overflow:"hidden"}),b.admin=!0,h.child("admin").once("value",function(c){var e=c.val(),h=d.$$route.originalPath;e.adminPass!=localStorage.adminLoged&&_.contains(g,h)?a.path("/"):(f.css({overflow:"auto"}),b.admin=!1)})})}]),angular.module("blacksunApp").controller("MainPageCtrl",["$scope","instagram","getInstgram","FBURL","$firebase",function(a,b,c,d,e){function f(a){var b=2,c=_.map(a.data,function(c){a.data.indexOf(c)===b?(g=376,h=376,b=6):(g=188,h=188);var d="";if(null!=c.caption)if(void 0===c.caption.text)d="#blackSunStore";else if(c.caption.text.length<50)d=c.caption.text;else{var e=c.caption.text.length-47,f=c.caption.text;d=f.substring(0,f.length-e)+"..."}else d="#blackSunStore";var i={link:c.link,image:c.images.low_resolution.url,imageHigh:c.images.standard_resolution.url,likes:c.likes.count,caption:d,imgWidth:g,imgHeight:h};return i});return c}a.slides=e(new Firebase(d+"/slider")),a.myInterval=6e3,a.highImage="http://placekitten.com/200/300",a.instaModal=!1;var g,h=0;localStorage.loadUrl=c.pagination.next_url,a.instagram_feed=f(c),a.loadImages=function(){var c=localStorage.loadUrl;b.instaPagination(c).then(function(b){localStorage.loadUrl=b.pagination.next_url,a.instagram_feed=_.union(a.instagram_feed,f(b)),$("body").animate({scrollTop:$(".sale-adds")[1].scrollHeight+1430},1500)})},a.imgeModal=function(b){a.imgObj=b,a.highImage=b.imageHigh,a.likes=b.likes,a.caption=b.caption,a.instaModal=!0},a.closeInstaModal=function(){a.instaModal=!1,a.imgIndex=0,i=0,j=0};var i=0,j=0;a.nextImg=function(){j=0,i+=1,a.imgIndex=a.imgIndex2?a.imgIndex2+i:_.indexOf(a.instagram_feed,a.imgObj)+i,a.imgIndex>a.instagram_feed.length-1&&(a.instaModal=!1,i=0,j=0),_.each(a.instagram_feed,function(b){a.instagram_feed.indexOf(b)===a.imgIndex&&(a.highImage=b.imageHigh,a.likes=b.likes,a.caption=b.caption)})},a.prevImg=function(){i=0,j+=1,a.imgIndex2=a.imgIndex?a.imgIndex-j:_.indexOf(a.instagram_feed,a.imgObj)-j,a.imgIndex2<0&&(a.instaModal=!1,i=0,j=0),_.each(a.instagram_feed,function(b){a.instagram_feed.indexOf(b)===a.imgIndex2&&(a.highImage=b.imageHigh,a.likes=b.likes,a.caption=b.caption)})}}]),angular.module("blacksunApp").factory("instagram",["$q","$http",function(a,b){var c="220451675.1fb234f.36e1b4878a8e4f34859b7a46c71736d8",d="220451675",e="https://api.instagram.com/v1/users/"+d+"/media/recent/?access_token="+c+"&count=14&callback=JSON_CALLBACK";return{getInstaStream:function(){var c=a.defer();return b.jsonp(e).success(function(a){c.resolve(a)}),c.promise},instaPagination:function(c){var d=c.substring(0,c.length-20)+"JSON_CALLBACK",e=a.defer();return b.jsonp(d).success(function(a){e.resolve(a)}),e.promise}}}]),angular.module("blacksunApp").constant("FBURL","https://blacksun.firebaseIO.com/"),angular.module("blacksunApp").controller("MotherCtrl",["$scope","$rootScope","FBURL","$firebase","$location","languagesSwitch",function(a,b,c,d,e,f){a.obj=[],a.showEmailInput=!0,a.repeatEmail=!1,a.i18n={};var g="US",h=["US","ES"],i=navigator.language||navigator.userLanguage,j=i.toUpperCase();"US"!=j?(_.contains(h,j)&&(g=j),f.getLanguages(g).then(function(b){a.i18n=b[g]})):f.getLanguages(g).then(function(b){a.i18n=b[g]}),a.emails=d(new Firebase(c+"/emails"));var k=new Firebase(c);a.submitEmail=function(){var c=_.pluck(b.emailsObj,"email");_.contains(c,a.obj.email)?a.repeatEmail=!0:(a.emails.$add({email:a.obj.email}),a.showEmailInput=!1,a.repeatEmail=!1)},a.openModal=function(){a.modal.show=!0},a.modal={show:!1,data:{obj:{},options:{}},callback:{loginAdmin:function(){var b=a.modal.data.obj;k.child("admin").once("value",function(c){var d=c.val();b.usr===d.adminUsr&&$.md5(b.pin)===d.adminPin&&$.md5(b.pass)===d.adminPass&&(a.modal.show=!1,e.path("/mainPageAdmin"),localStorage.adminLoged=d.adminPass)})}}}}]),angular.module("blacksunApp").factory("FBretrieves",["FBURL","$firebase","$q",function(a,b,c){var d=new Firebase(a);return{retrieveEmails:function(){var a=c.defer(),b=d.child("emails/");return b.once("value",function(b){a.resolve(b.val())}),a.promise},getSliderImg:function(){var a=c.defer(),b=d.child("slider/");return b.once("value",function(b){a.resolve(b.val())}),a.promise}}}]),angular.module("blacksunApp").controller("MainpageadminCtrl",["$scope","FBURL","$firebase",function(a,b,c){a.imgs=c(new Firebase(b+"/slider"));var d=new Firebase(b+"/slider");AWS.config.update({accessKeyId:"AKIAIWOR3KNGZBKQJ3CA",secretAccessKey:"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"});var e=new AWS.S3({params:{Bucket:"blaksun"}});a.deleteImage=function(b){d.once("value",function(c){var d=_.findKey(c.val(),{id:b.id});a.imgs.$child(d).$remove()});var c={Key:b.name};e.deleteObject(c,function(a){a?console.log("error"):console.log("succes")})}}]),angular.module("blacksunApp").directive("s3uploader",["imagesPath",function(a){return{restrict:"E",templateUrl:function(a,b){return b.templateUrl},scope:{accesskey:"@",secretkey:"@",bucket:"@",imgwidth:"@",imgheight:"@",imgsize:"@",template:"@",fbpath:"@"},link:function(b){function c(a){if(a.files&&a.files[0]&&a.files[0].type.match("image.*")){var c=new FileReader;c.onload=function(a){b.previewIMG=a.target.result,b.$apply()},c.readAsDataURL(a.files[0])}else b.previewIMG="",b.$apply()}AWS.config.update({accessKeyId:b.accesskey,secretAccessKey:b.secretkey});var d=new AWS.S3({params:{Bucket:b.bucket}}),e=$("#file-chooser"),f=$("#upload-button");b.imgName="",b.file="",b.thereIs=!0,b.bar="0%",b.imghref="",b.success=!1,b.iserror=!1,b.nothing=!1,e.change(function(){c(this),b.file=this.files[0],b.bar="0%",b.imgName=b.file?b.file.name.substring(0,b.file.name.length-4):"",b.thereIs=void 0===b.file?!0:!1,$("#bar").addClass("active"),b.$apply()}),f.on("click",function(){if(b.file){var c=b.file.type.substring(6);if(b.file.type.match("image.*")&&b.file.size<b.imgsize){var e={Key:b.imgName+"."+c,ContentType:b.file.type,Body:b.file};d.putObject(e,function(d){if(d)b.iserror=!0;else{b.success=!0,b.iserror=!1,$("#bar").removeClass("active");var e="https://s3.amazonaws.com/blaksun/"+b.imgName+"."+c,f=b.imgName+"."+c;a.saveImge(b.fbpath,e,f,b.imghref)}b.$apply()}).on("httpUploadProgress",function(a){b.percent=a.loaded/a.total*100,b.bar=b.percent+"%",b.$apply()})}else b.nothing=!0}else console.log("nothing"),b.nothing=!0;b.$apply()})}}}]),angular.module("blacksunApp").factory("imagesPath",["FBURL","$firebase","$q",function(a,b){return{saveImge:function(c,d,e,f){var g=b(new Firebase(a+"/"+c)),h=Math.random().toString(36).substr(2,9),i="_blank";""===f&&(f="#/",i="_self"),g.$add({url:d,id:h,name:e,ref:f,tar:i})}}}]),angular.module("blacksunApp").directive("modal",function(){return{restrict:"E",templateUrl:"views/directives/modal.html",scope:{data:"=modaldata",callback:"=",template:"@",show:"=",minWidth:"@",maxWidth:"@",maxHeight:"@"},controller:["$scope","$element","$attrs",function(a){var b,c;b=angular.element(document.body),c="modal-open",a.$watch("show",function(){return a.show?b.addClass(c):b.removeClass(c)}),a.closeModal=function(){return a.show=!1}}]}}),angular.module("blacksunApp").factory("languagesSwitch",["$http","$q",function(a,b){return{getLanguages:function(c){var d=b.defer();return a.get("scripts/i18n/lang_"+c+".json").success(function(a){d.resolve(a)}).error(function(){d.reject()}),d.promise}}}]);